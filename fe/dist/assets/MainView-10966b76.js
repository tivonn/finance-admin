import{d as z,u as F,a as T,r as N,k as D,n as E,i as l,o as d,p as f,w as a,e as _,t as y,f as w,b as r,q as R,h as A,m as $,s as L,v as Z,x as G,j as V,c as B,y as j,F as I,z as H,R as J,A as Q,C as W}from"./index-a9039ce2.js";import{_ as X}from"./Language.vue_vue_type_style_index_0_lang-534cb61c.js";const Y="/assets/avatar-49f3946b.png",ee={class:"user-info"},se={class:"username"},oe={class:"account"},ae=z({__name:"UpdateUserModal",emits:["closeModal"],setup(K,{emit:m}){const{t:i}=F(),n=T(),x=m,b=N(),t=D({phone_number:"",password:"",confirm_password:""});E(async()=>{await n.getUser();const{phone_number:s}=n.user;Object.assign(t,{phone_number:s})});const M=async(s,e)=>t.password!==""&&e!==t.password?Promise.reject(i("updateUserModal.message.confirmPasswordInvalid")):Promise.resolve(),C=async()=>{var s,e;try{await b.value.validateFields();try{const{username:o,account:g,role:p,is_modified_password:U}=n.user,{phone_number:k,password:c}=t;await A.put(`/user/${n.user.id}`,{username:o,account:g,role:p,phone_number:k||"",password:c||""}),$.success(i("updateUserModal.message.updateUserSuccess")),await n.getUser(),!U&&n.user.is_modified_password?window.location.reload():P()}catch(o){switch((e=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:e.message){case"无权限":{$.error(i("common.message.noAuth"));break}default:$.error(i("updateUserModal.message.updateUserFailed"))}}}catch{}},v=()=>{P()},P=()=>{n.user.is_modified_password?x("closeModal"):$.error(i("common.message.noModifiedPassword"))};return(s,e)=>{const o=l("a-input"),g=l("a-form-item"),p=l("a-input-password"),U=l("a-form"),k=l("a-modal");return d(),f(k,{class:"update-user-modal",visible:!0,title:`${s.$t("updateUserModal.info.updateUser")}${w(n).user.is_modified_password?"":`(${s.$t("common.message.noModifiedPassword")})`}`,maskClosable:w(n).user.is_modified_password,cancelText:s.$t("common.actions.cancel"),okText:s.$t("common.actions.confirm"),onOk:e[3]||(e[3]=()=>C()),onCancel:e[4]||(e[4]=()=>v())},{default:a(()=>[_("p",ee,[_("span",se,y(w(n).user.username),1),_("span",oe,"("+y(w(n).user.account)+")",1)]),r(U,{ref_key:"formRef",ref:b,model:t,"label-col":{offset:1,span:5},"wrapper-col":{offset:1,span:16}},{default:a(()=>[r(g,{label:s.$t("commonBiz.user.phoneNumber"),name:"phone_number",rules:[{required:!0,message:s.$t("upsertUserModal.message.phoneNumberInvalid")},{pattern:/^[\d\-+]{7,20}$/,message:s.$t("upsertUserModal.message.phoneNumberPatternInvalid")}]},{default:a(()=>[r(o,{value:t.phone_number,"onUpdate:value":e[0]||(e[0]=c=>t.phone_number=c),placeholder:s.$t("updateUserModal.info.phoneNumberPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label","rules"]),r(g,{label:s.$t("commonBiz.user.password"),name:"password",rules:[{required:!w(n).user.is_modified_password,message:s.$t("updateUserModal.message.passwordInvalid")},{pattern:/^[a-zA-Z0-9]{8,20}$/,message:s.$t("updateUserModal.message.passwordPatternInvalid")}]},{default:a(()=>[r(p,{value:t.password,"onUpdate:value":e[1]||(e[1]=c=>t.password=c),placeholder:s.$t("updateUserModal.info.passwordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label","rules"]),t.password!==""?(d(),f(g,{key:0,label:s.$t("commonBiz.user.confirmPassword"),name:"confirm_password",rules:[{validator:M,trigger:"change"}]},{default:a(()=>[r(p,{value:t.confirm_password,"onUpdate:value":e[2]||(e[2]=c=>t.confirm_password=c),placeholder:s.$t("updateUserModal.info.confirmPasswordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label","rules"])):R("",!0)]),_:1},8,["model"])]),_:1},8,["title","maskClosable","cancelText","okText"])}}});const te={class:"main-actions"},re=["src"],ue=z({__name:"MainView",setup(K){const{t:m}=F(),i=T(),n=Z(),x=N([{key:"/order",text:m("route.order"),route:{name:"order"}},{key:"/report",text:m("route.report"),route:{name:"report"},subs:[{key:"/report/bank",text:m("route.reports.bankReport"),route:{name:"bankReport"}},{key:"/report/subject/collect",text:m("route.reports.subjectCollect"),route:{name:"subjectCollect"}},{key:"/report/profit",text:m("route.reports.profit"),route:{name:"profit"}}]},{key:"/manage",text:m("route.manage"),route:{name:"manage"},subs:[{key:"/manage/user",text:m("route.manages.manageUser"),route:{name:"manageUser"}}]}]),b=N([n.path.slice(5)]),t=e=>(Q[e].allows||[]).includes(i.user.role),M=e=>{var o;W.push({name:(o=e.route)==null?void 0:o.name})},C=N(!1),v=e=>{C.value=e},P=()=>{v(!0)};L(()=>{i.isLogin&&!i.user.is_modified_password&&v(!0)});const s=()=>{try{A.post("/user/logout")}catch{$.error(m("common.message.logoutFailed"))}};return(e,o)=>{const g=l("a-tag"),p=l("a-menu-item"),U=l("a-sub-menu"),k=l("a-menu"),c=l("a-dropdown"),S=l("a-layout-header"),q=l("a-layout-content"),O=l("a-layout");return d(),f(O,{class:"main-view"},{default:a(()=>[r(S,{class:"main-header"},{default:a(()=>[w(G)()?(d(),f(g,{key:0,color:"blue",class:"local-tag"},{default:a(()=>[V("本地开发")]),_:1})):R("",!0),r(k,{selectedKeys:b.value,"onUpdate:selectedKeys":o[0]||(o[0]=u=>b.value=u),theme:"dark",mode:"horizontal",class:"main-navigation"},{default:a(()=>[(d(!0),B(I,null,j(x.value.filter(u=>t(u.route.name)),u=>(d(),B(I,null,[u.subs?(d(),f(U,{key:`${u.key}-sub`},{title:a(()=>[_("span",null,y(u.text),1)]),default:a(()=>[(d(!0),B(I,null,j(u.subs.filter(h=>t(h.route.name)),h=>(d(),f(p,{key:h.key,onClick:()=>M(h)},{default:a(()=>[V(y(h.text),1)]),_:2},1032,["onClick"]))),128))]),_:2},1024)):(d(),f(p,{key:u.key,onClick:()=>M(u)},{default:a(()=>[_("span",null,y(u.text),1)]),_:2},1032,["onClick"]))],64))),256))]),_:1},8,["selectedKeys"]),_("div",te,[r(X,{class:"language"}),r(c,null,{overlay:a(()=>[r(k,null,{default:a(()=>[r(p,{onClick:o[2]||(o[2]=()=>P())},{default:a(()=>[_("span",null,y(e.$t("common.actions.updateUser")),1)]),_:1}),r(p,{onClick:o[3]||(o[3]=()=>s())},{default:a(()=>[_("span",null,y(e.$t("common.actions.logout")),1)]),_:1})]),_:1})]),default:a(()=>[_("img",{src:w(Y),class:"avatar",onClick:o[1]||(o[1]=H(()=>{},["prevent"]))},null,8,re)]),_:1})])]),_:1}),r(q,{class:"main-content"},{default:a(()=>[r(w(J))]),_:1}),C.value?(d(),f(ae,{key:0,onCloseModal:o[4]||(o[4]=()=>v(!1))})):R("",!0)]),_:1})}}});export{ue as default};
