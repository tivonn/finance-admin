import{d as I,u as V,a as z,r as j,k as q,n as O,i as u,o as i,p as f,w as a,e as _,t as w,f as g,b as r,q as F,h as T,m as $,s as E,v as L,c as R,x as B,F as N,y as D,R as Z,z as G,j as H,A as J}from"./index-0e27d8eb.js";import{_ as Q}from"./Language.vue_vue_type_style_index_0_lang-92ea8589.js";const W="/assets/avatar-49f3946b.png",X={class:"user-info"},Y={class:"username"},ee={class:"account"},se=I({__name:"UpdateUserModal",emits:["closeModal"],setup(A,{emit:l}){const{t:p}=V(),n=z(),x=l,k=j(),t=q({phone_number:"",password:"",confirm_password:""});O(async()=>{await n.getUser();const{phone_number:s}=n.user;Object.assign(t,{phone_number:s})});const M=async(s,e)=>t.password!==""&&e!==t.password?Promise.reject(p("updateUserModal.message.confirmPasswordInvalid")):Promise.resolve(),C=async()=>{var s,e;try{await k.value.validateFields();try{const{username:o,account:m,role:b,is_modified_password:y}=n.user,{phone_number:U,password:c}=t;await T.put(`/user/${n.user.id}`,{username:o,account:m,role:b,phone_number:U||"",password:c||""}),$.success(p("updateUserModal.message.updateUserSuccess")),await n.getUser(),!y&&n.user.is_modified_password?window.location.reload():P()}catch(o){switch((e=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:e.message){case"无权限":{$.error(p("common.message.noAuth"));break}default:$.error(p("updateUserModal.message.updateUserFailed"))}}}catch{}},v=()=>{P()},P=()=>{n.user.is_modified_password?x("closeModal"):$.error(p("common.message.noModifiedPassword"))};return(s,e)=>{const o=u("a-input"),m=u("a-form-item"),b=u("a-input-password"),y=u("a-form"),U=u("a-modal");return i(),f(U,{class:"update-user-modal",visible:!0,title:`${s.$t("updateUserModal.info.updateUser")}${g(n).user.is_modified_password?"":`(${s.$t("common.message.noModifiedPassword")})`}`,maskClosable:g(n).user.is_modified_password,cancelText:s.$t("common.actions.cancel"),okText:s.$t("common.actions.confirm"),onOk:e[3]||(e[3]=()=>C()),onCancel:e[4]||(e[4]=()=>v())},{default:a(()=>[_("p",X,[_("span",Y,w(g(n).user.username),1),_("span",ee,"("+w(g(n).user.account)+")",1)]),r(y,{ref_key:"formRef",ref:k,model:t,"label-col":{offset:1,span:5},"wrapper-col":{offset:1,span:16}},{default:a(()=>[r(m,{label:s.$t("commonBiz.user.phoneNumber"),name:"phone_number",rules:[{required:!0,message:s.$t("upsertUserModal.message.phoneNumberInvalid")},{pattern:/^[\d\-+]{7,20}$/,message:s.$t("upsertUserModal.message.phoneNumberPatternInvalid")}]},{default:a(()=>[r(o,{value:t.phone_number,"onUpdate:value":e[0]||(e[0]=c=>t.phone_number=c),placeholder:s.$t("updateUserModal.info.phoneNumberPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label","rules"]),r(m,{label:s.$t("commonBiz.user.password"),name:"password",rules:[{required:!g(n).user.is_modified_password,message:s.$t("updateUserModal.message.passwordInvalid")},{pattern:/^[a-zA-Z0-9]{8,20}$/,message:s.$t("updateUserModal.message.passwordPatternInvalid")}]},{default:a(()=>[r(b,{value:t.password,"onUpdate:value":e[1]||(e[1]=c=>t.password=c),placeholder:s.$t("updateUserModal.info.passwordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label","rules"]),t.password!==""?(i(),f(m,{key:0,label:s.$t("commonBiz.user.confirmPassword"),name:"confirm_password",rules:[{validator:M,trigger:"change"}]},{default:a(()=>[r(b,{value:t.confirm_password,"onUpdate:value":e[2]||(e[2]=c=>t.confirm_password=c),placeholder:s.$t("updateUserModal.info.confirmPasswordPlaceholder")},null,8,["value","placeholder"])]),_:1},8,["label","rules"])):F("",!0)]),_:1},8,["model"])]),_:1},8,["title","maskClosable","cancelText","okText"])}}});const oe={class:"main-actions"},ae=["src"],ne=I({__name:"MainView",setup(A){const{t:l}=V(),p=z(),n=L(),x=j([{key:"/order",text:l("route.order"),route:{name:"order"}},{key:"/report",text:l("route.report"),route:{name:"report"},subs:[{key:"/report/bank",text:l("route.reports.bankReport"),route:{name:"bankReport"}},{key:"/report/subject/collect",text:l("route.reports.subjectCollect"),route:{name:"subjectCollect"}},{key:"/report/profit",text:l("route.reports.profit"),route:{name:"profit"}},{key:"/report/subject/remain",text:l("route.reports.subjectRemain"),route:{name:"subjectRemain"}},{key:"/report/debt",text:l("route.reports.debt"),route:{name:"debt"}}]},{key:"/manage",text:l("route.manage"),route:{name:"manage"},subs:[{key:"/manage/user",text:l("route.manages.manageUser"),route:{name:"manageUser"}}]}]),k=j([n.path.slice(5)]),t=e=>(G[e].allows||[]).includes(p.user.role),M=e=>{var o;J.push({name:(o=e.route)==null?void 0:o.name})},C=j(!1),v=e=>{C.value=e},P=()=>{v(!0)};E(()=>{p.isLogin&&!p.user.is_modified_password&&v(!0)});const s=()=>{try{T.post("/user/logout")}catch{$.error(l("common.message.logoutFailed"))}};return(e,o)=>{const m=u("a-menu-item"),b=u("a-sub-menu"),y=u("a-menu"),U=u("a-dropdown"),c=u("a-layout-header"),K=u("a-layout-content"),S=u("a-layout");return i(),f(S,{class:"main-view"},{default:a(()=>[r(c,{class:"main-header"},{default:a(()=>[r(y,{selectedKeys:k.value,"onUpdate:selectedKeys":o[0]||(o[0]=d=>k.value=d),theme:"dark",mode:"horizontal",class:"main-navigation"},{default:a(()=>[(i(!0),R(N,null,B(x.value.filter(d=>t(d.route.name)),d=>(i(),R(N,null,[d.subs?(i(),f(b,{key:`${d.key}-sub`},{title:a(()=>[_("span",null,w(d.text),1)]),default:a(()=>[(i(!0),R(N,null,B(d.subs.filter(h=>t(h.route.name)),h=>(i(),f(m,{key:h.key,onClick:()=>M(h)},{default:a(()=>[H(w(h.text),1)]),_:2},1032,["onClick"]))),128))]),_:2},1024)):(i(),f(m,{key:d.key,onClick:()=>M(d)},{default:a(()=>[_("span",null,w(d.text),1)]),_:2},1032,["onClick"]))],64))),256))]),_:1},8,["selectedKeys"]),_("div",oe,[r(Q,{class:"language"}),r(U,null,{overlay:a(()=>[r(y,null,{default:a(()=>[r(m,{onClick:o[2]||(o[2]=()=>P())},{default:a(()=>[_("span",null,w(e.$t("common.actions.updateUser")),1)]),_:1}),r(m,{onClick:o[3]||(o[3]=()=>s())},{default:a(()=>[_("span",null,w(e.$t("common.actions.logout")),1)]),_:1})]),_:1})]),default:a(()=>[_("img",{src:g(W),class:"avatar",onClick:o[1]||(o[1]=D(()=>{},["prevent"]))},null,8,ae)]),_:1})])]),_:1}),r(K,{class:"main-content"},{default:a(()=>[r(g(Z))]),_:1}),C.value?(i(),f(se,{key:0,onCloseModal:o[4]||(o[4]=()=>v(!1))})):F("",!0)]),_:1})}}});export{ne as default};
